import base64,codecs
exec(base64.b64decode("IyBTdGFyIFN0ZWFsZXIgLSBSZWFkeSB0byBydW4gUHl0aG9uIHZlcnNpb24KIyBUZWxlZ3JhbSBDMiB3aXRoIGxvZ2dpbmcgc3VwcG9ydAojIFB5dGhvbiAzLjEwKyB8IFdpbmRvd3MgT25seQoKIyA9PT09PT09PT09PT09PSBBVVRPIElOU1RBTEwgREVQRU5ERU5DSUVTID09PT09PT09PT09PT09CmltcG9ydCBzdWJwcm9jZXNzCmltcG9ydCBzeXMKaW1wb3J0IHRpbWUKaW1wb3J0IHNvY2tldAoKZGVmIGlzX2Nvbm5lY3RlZCgpOgogICAgIiIi0J/RgNC+0LLQtdGA0Y/QtdGCINC/0L7QtNC60LvRjtGH0LXQvdC40LUg0Log0LjQvdGC0LXRgNC90LXRgtGDIiIiCiAgICB0cnk6CiAgICAgICAgc29ja2V0LmNyZWF0ZV9jb25uZWN0aW9uKCgiOC44LjguOCIsIDUzKSwgdGltZW91dD0zKQogICAgICAgIHJldHVybiBUcnVlCiAgICBleGNlcHQ6CiAgICAgICAgcmV0dXJuIEZhbHNlCgpkZWYgd2FpdF9mb3JfaW50ZXJuZXQoY2hlY2tfaW50ZXJ2YWw9NSk6CiAgICAiIiLQltC00ZHRgiDQv9C+0LTQutC70Y7Rh9C10L3QuNGPINC6INC40L3RgtC10YDQvdC10YLRgyIiIgogICAgd2hpbGUgbm90IGlzX2Nvbm5lY3RlZCgpOgogICAgICAgIHRpbWUuc2xlZXAoY2hlY2tfaW50ZXJ2YWwpCgpkZWYgaW5zdGFsbF9wYWNrYWdlKHBhY2thZ2UpOgogICAgIiIi0JDQstGC0L7QvNCw0YLQuNGH0LXRgdC60LDRjyDRg9GB0YLQsNC90L7QstC60LAg0L/QsNC60LXRgtC+0LIg0YEg0L7QttC40LTQsNC90LjQtdC8INC40L3RgtC10YDQvdC10YLQsCIiIgogICAgd2FpdF9mb3JfaW50ZXJuZXQoKQogICAgdHJ5OgogICAgICAgIHN1YnByb2Nlc3MuY2hlY2tfY2FsbChbc3lzLmV4ZWN1dGFibGUsICItbSIsICJwaXAiLCAiaW5zdGFsbCIsIHBhY2thZ2UsICItcSIsICItLWRpc2FibGUtcGlwLXZlcnNpb24tY2hlY2siXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0ZG91dD1zdWJwcm9jZXNzLkRFVk5VTEwsIHN0ZGVycj1zdWJwcm9jZXNzLkRFVk5VTEwpCiAgICBleGNlcHQ6CiAgICAgICAgcGFzcwoKIyDQltC00ZHQvCDQuNC90YLQtdGA0L3QtdGCINC/0LXRgNC10LQg0YPRgdGC0LDQvdC+0LLQutC+0LkKd2FpdF9mb3JfaW50ZXJuZXQoKQoKIyDQodC/0LjRgdC+0Log0L3QtdC+0LHRhdC+0LTQuNC80YvRhSDQv9Cw0LrQtdGC0L7QsgpyZXF1aXJlZF9wYWNrYWdlcyA9IFsicHlhZXMiLCAib3BlbnRlbGUiLCAidGVsZXRob24iXQoKZm9yIHBrZyBpbiByZXF1aXJlZF9wYWNrYWdlczoKICAgIHRyeToKICAgICAgICBfX2ltcG9ydF9fKHBrZykKICAgIGV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgICAgICBpbnN0YWxsX3BhY2thZ2UocGtnKQoKIyA9PT09PT09PT09PT09PSBJTVBPUlRTID09PT09PT09PT09PT09CmltcG9ydCBiYXNlNjQKaW1wb3J0IG9zCmltcG9ydCBqc29uCmltcG9ydCByYW5kb20KaW1wb3J0IHNodXRpbAppbXBvcnQgc3FsaXRlMwppbXBvcnQgcmUKaW1wb3J0IHRyYWNlYmFjawppbXBvcnQgdGltZQppbXBvcnQgY3R5cGVzCmltcG9ydCBsb2dnaW5nCmltcG9ydCB6bGliCmltcG9ydCBpbwpmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRldGltZQpmcm9tIHRocmVhZGluZyBpbXBvcnQgVGhyZWFkCmZyb20gdXJsbGliLnJlcXVlc3QgaW1wb3J0IHVybG9wZW4sIFJlcXVlc3QKZnJvbSB1cmxsaWIucGFyc2UgaW1wb3J0IHF1b3RlCmZyb20gdXJsbGliLmVycm9yIGltcG9ydCBVUkxFcnJvcgoKIyA9PT09PT09PT09PT09PSBURUxFR1JBTSBDT05GSUdVUkFUSU9OID09PT09PT09PT09PT09ClRFTEVHUkFNX1RPS0VOID0gIjcwODc5MDkxMTg6QUFHeUFnb1VLYjJpRUFfV1dXRFRTTkFqUl80aE94SEEyamciClRFTEVHUkFNX0NIQVRfSUQgPSAiMTA1NjE0ODk0NyIKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CgpjbGFzcyBUZWxlZ3JhbUxvZ2dlcjoKICAgICIiItCe0YLQv9GA0LDQstC70Y/QtdGCINC70L7Qs9C4INCyIFRlbGVncmFtIiIiCiAgICAKICAgIGRlZiBfX2luaXRfXyhzZWxmLCB0b2tlbjogc3RyLCBjaGF0X2lkOiBzdHIpOgogICAgICAgIHNlbGYudG9rZW4gPSB0b2tlbgogICAgICAgIHNlbGYuY2hhdF9pZCA9IGNoYXRfaWQKICAgICAgICBzZWxmLmxvZ19idWZmZXIgPSBbXQogICAgICAgIHNlbGYuZW5hYmxlZCA9IFRydWUKICAgIAogICAgZGVmIF9zZW5kX21lc3NhZ2Uoc2VsZiwgdGV4dDogc3RyLCBwYXJzZV9tb2RlOiBzdHIgPSAiSFRNTCIpIC0+IGJvb2w6CiAgICAgICAgIiIi0J7RgtC/0YDQsNCy0LvRj9C10YIg0YHQvtC+0LHRidC10L3QuNC1INCyIFRlbGVncmFtIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICB1cmwgPSBmImh0dHBzOi8vYXBpLnRlbGVncmFtLm9yZy9ib3R7c2VsZi50b2tlbn0vc2VuZE1lc3NhZ2UiCiAgICAgICAgICAgIGRhdGEgPSBqc29uLmR1bXBzKHsKICAgICAgICAgICAgICAgICJjaGF0X2lkIjogc2VsZi5jaGF0X2lkLAogICAgICAgICAgICAgICAgInRleHQiOiB0ZXh0Wzo0MDk2XSwgICMgVGVsZWdyYW0gbGltaXQKICAgICAgICAgICAgICAgICJwYXJzZV9tb2RlIjogcGFyc2VfbW9kZQogICAgICAgICAgICB9KS5lbmNvZGUoJ3V0Zi04JykKICAgICAgICAgICAgCiAgICAgICAgICAgIHJlcSA9IFJlcXVlc3QodXJsLCBkYXRhPWRhdGEsIGhlYWRlcnM9eyJDb250ZW50LVR5cGUiOiAiYXBwbGljYXRpb24vanNvbiJ9KQogICAgICAgICAgICB3aXRoIHVybG9wZW4ocmVxLCB0aW1lb3V0PTEwKSBhcyByZXNwb25zZToKICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMgPT0gMjAwCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltURyBFcnJvcl0ge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfc2VuZF9kb2N1bWVudChzZWxmLCBmaWxlX3BhdGg6IHN0ciwgY2FwdGlvbjogc3RyID0gIiIpIC0+IGJvb2w6CiAgICAgICAgIiIi0J7RgtC/0YDQsNCy0LvRj9C10YIg0YTQsNC50Lsg0LIgVGVsZWdyYW0iIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGltcG9ydCB1cmxsaWIucmVxdWVzdAogICAgICAgICAgICBpbXBvcnQgbWltZXR5cGVzCiAgICAgICAgICAgIAogICAgICAgICAgICBib3VuZGFyeSA9ICctLS0tV2ViS2l0Rm9ybUJvdW5kYXJ5JyArICcnLmpvaW4ocmFuZG9tLmNob2ljZXMoJ2FiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6Jywgaz0xNikpCiAgICAgICAgICAgIAogICAgICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAncmInKSBhcyBmOgogICAgICAgICAgICAgICAgZmlsZV9kYXRhID0gZi5yZWFkKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGZpbGVuYW1lID0gb3MucGF0aC5iYXNlbmFtZShmaWxlX3BhdGgpCiAgICAgICAgICAgIAogICAgICAgICAgICBib2R5ID0gKAogICAgICAgICAgICAgICAgZictLXtib3VuZGFyeX1cclxuJwogICAgICAgICAgICAgICAgZidDb250ZW50LURpc3Bvc2l0aW9uOiBmb3JtLWRhdGE7IG5hbWU9ImNoYXRfaWQiXHJcblxyXG57c2VsZi5jaGF0X2lkfVxyXG4nCiAgICAgICAgICAgICAgICBmJy0te2JvdW5kYXJ5fVxyXG4nCiAgICAgICAgICAgICAgICBmJ0NvbnRlbnQtRGlzcG9zaXRpb246IGZvcm0tZGF0YTsgbmFtZT0iY2FwdGlvbiJcclxuXHJcbntjYXB0aW9ufVxyXG4nCiAgICAgICAgICAgICAgICBmJy0te2JvdW5kYXJ5fVxyXG4nCiAgICAgICAgICAgICAgICBmJ0NvbnRlbnQtRGlzcG9zaXRpb246IGZvcm0tZGF0YTsgbmFtZT0iZG9jdW1lbnQiOyBmaWxlbmFtZT0ie2ZpbGVuYW1lfSJcclxuJwogICAgICAgICAgICAgICAgZidDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL29jdGV0LXN0cmVhbVxyXG5cclxuJwogICAgICAgICAgICApLmVuY29kZSgndXRmLTgnKSArIGZpbGVfZGF0YSArIGYnXHJcbi0te2JvdW5kYXJ5fS0tXHJcbicuZW5jb2RlKCd1dGYtOCcpCiAgICAgICAgICAgIAogICAgICAgICAgICB1cmwgPSBmImh0dHBzOi8vYXBpLnRlbGVncmFtLm9yZy9ib3R7c2VsZi50b2tlbn0vc2VuZERvY3VtZW50IgogICAgICAgICAgICByZXEgPSBSZXF1ZXN0KHVybCwgZGF0YT1ib2R5KQogICAgICAgICAgICByZXEuYWRkX2hlYWRlcignQ29udGVudC1UeXBlJywgZidtdWx0aXBhcnQvZm9ybS1kYXRhOyBib3VuZGFyeT17Ym91bmRhcnl9JykKICAgICAgICAgICAgCiAgICAgICAgICAgIHdpdGggdXJsb3BlbihyZXEsIHRpbWVvdXQ9NjApIGFzIHJlc3BvbnNlOgogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyA9PSAyMDAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiW1RHIERvY3VtZW50IEVycm9yXSB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIGxvZyhzZWxmLCBsZXZlbDogc3RyLCBtZXNzYWdlOiBzdHIpOgogICAgICAgICIiItCU0L7QsdCw0LLQu9GP0LXRgiDQu9C+0LMg0LIg0LHRg9GE0LXRgCDQuCDQstGL0LLQvtC00LjRgiDQsiDQutC+0L3RgdC+0LvRjCIiIgogICAgICAgIHRpbWVzdGFtcCA9IGRhdGV0aW1lLm5vdygpLnN0cmZ0aW1lKCIlSDolTTolUyIpCiAgICAgICAgbG9nX2VudHJ5ID0gZiJbe3RpbWVzdGFtcH1dIFt7bGV2ZWx9XSB7bWVzc2FnZX0iCiAgICAgICAgc2VsZi5sb2dfYnVmZmVyLmFwcGVuZChsb2dfZW50cnkpCiAgICAgICAgcHJpbnQobG9nX2VudHJ5KQogICAgCiAgICBkZWYgaW5mbyhzZWxmLCBtZXNzYWdlOiBzdHIpOgogICAgICAgIHNlbGYubG9nKCJJTkZPIiwgbWVzc2FnZSkKICAgIAogICAgZGVmIHdhcm5pbmcoc2VsZiwgbWVzc2FnZTogc3RyKToKICAgICAgICBzZWxmLmxvZygiV0FSTklORyIsIG1lc3NhZ2UpCiAgICAKICAgIGRlZiBlcnJvcihzZWxmLCBtZXNzYWdlOiBzdHIpOgogICAgICAgIHNlbGYubG9nKCJFUlJPUiIsIG1lc3NhZ2UpCiAgICAKICAgIGRlZiBzZW5kX3N0YXJ0dXBfbm90aWZpY2F0aW9uKHNlbGYpOgogICAgICAgICIiItCe0YLQv9GA0LDQstC70Y/QtdGCINGD0LLQtdC00L7QvNC70LXQvdC40LUg0L4g0LfQsNC/0YPRgdC60LUiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGNvbXB1dGVyX25hbWUgPSBvcy5nZXRlbnYoImNvbXB1dGVybmFtZSIsICJVbmtub3duIikKICAgICAgICAgICAgdXNlcm5hbWUgPSBvcy5nZXRsb2dpbigpCiAgICAgICAgICAgIAogICAgICAgICAgICBtZXNzYWdlID0gKAogICAgICAgICAgICAgICAgIvCfmoAgPGI+U3RhciBTdGVhbGVyIFN0YXJ0ZWQ8L2I+XG5cbiIKICAgICAgICAgICAgICAgIGYi8J+RpCA8Yj5Vc2VyOjwvYj4gPGNvZGU+e3VzZXJuYW1lfTwvY29kZT5cbiIKICAgICAgICAgICAgICAgIGYi8J+SuyA8Yj5Db21wdXRlcjo8L2I+IDxjb2RlPntjb21wdXRlcl9uYW1lfTwvY29kZT5cbiIKICAgICAgICAgICAgICAgIGYi8J+VkCA8Yj5UaW1lOjwvYj4gPGNvZGU+e2RhdGV0aW1lLm5vdygpLnN0cmZ0aW1lKCclWS0lbS0lZCAlSDolTTolUycpfTwvY29kZT4iCiAgICAgICAgICAgICkKICAgICAgICAgICAgc2VsZi5fc2VuZF9tZXNzYWdlKG1lc3NhZ2UpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltTdGFydHVwIG5vdGlmaWNhdGlvbiBlcnJvcl0ge2V9IikKICAgIAogICAgZGVmIHNlbmRfbG9ncyhzZWxmKToKICAgICAgICAiIiLQntGC0L/RgNCw0LLQu9GP0LXRgiDQvdCw0LrQvtC/0LvQtdC90L3Ri9C1INC70L7Qs9C4INCyIFRlbGVncmFtIiIiCiAgICAgICAgaWYgbm90IHNlbGYubG9nX2J1ZmZlcjoKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICAgICAgbG9nc190ZXh0ID0gIlxuIi5qb2luKHNlbGYubG9nX2J1ZmZlclstNTA6XSkgICMg0J/QvtGB0LvQtdC00L3QuNC1IDUwINC30LDQv9C40YHQtdC5CiAgICAgICAgbWVzc2FnZSA9IGYi8J+TiyA8Yj5FeGVjdXRpb24gTG9nczwvYj5cblxuPHByZT57bG9nc190ZXh0WzozODAwXX08L3ByZT4iCiAgICAgICAgc2VsZi5fc2VuZF9tZXNzYWdlKG1lc3NhZ2UpCiAgICAKICAgIGRlZiBzZW5kX2NvbXBsZXRpb25fbm90aWZpY2F0aW9uKHNlbGYsIHN0YXRzOiBkaWN0KToKICAgICAgICAiIiLQntGC0L/RgNCw0LLQu9GP0LXRgiDRg9Cy0LXQtNC+0LzQu9C10L3QuNC1INC+INC30LDQstC10YDRiNC10L3QuNC4INGBINGB0YLQsNGC0LjRgdGC0LjQutC+0LkiIiIKICAgICAgICBzdGF0c190ZXh0ID0gIlxuIi5qb2luKFtmIuKAoiB7a306IHt2fSIgZm9yIGssIHYgaW4gc3RhdHMuaXRlbXMoKV0pCiAgICAgICAgbWVzc2FnZSA9ICgKICAgICAgICAgICAgIuKchSA8Yj5TdGFyIFN0ZWFsZXIgQ29tcGxldGVkPC9iPlxuXG4iCiAgICAgICAgICAgIGYi8J+TiiA8Yj5TdGF0aXN0aWNzOjwvYj5cbjxwcmU+e3N0YXRzX3RleHR9PC9wcmU+IgogICAgICAgICkKICAgICAgICBzZWxmLl9zZW5kX21lc3NhZ2UobWVzc2FnZSkKICAgIAogICAgZGVmIHNlbmRfZXJyb3Jfbm90aWZpY2F0aW9uKHNlbGYsIGVycm9yOiBzdHIpOgogICAgICAgICIiItCe0YLQv9GA0LDQstC70Y/QtdGCINGD0LLQtdC00L7QvNC70LXQvdC40LUg0L7QsSDQvtGI0LjQsdC60LUiIiIKICAgICAgICBtZXNzYWdlID0gZiLinYwgPGI+RXJyb3Igb2NjdXJyZWQ8L2I+XG5cbjxwcmU+e2Vycm9yWzozODAwXX08L3ByZT4iCiAgICAgICAgc2VsZi5fc2VuZF9tZXNzYWdlKG1lc3NhZ2UpCiAgICAKICAgIGRlZiBzZW5kX2ZpbGUoc2VsZiwgZmlsZV9wYXRoOiBzdHIsIGNhcHRpb246IHN0ciA9ICIiKToKICAgICAgICAiIiLQntGC0L/RgNCw0LLQu9GP0LXRgiDRhNCw0LnQuyDQsiBUZWxlZ3JhbSIiIgogICAgICAgIHJldHVybiBzZWxmLl9zZW5kX2RvY3VtZW50KGZpbGVfcGF0aCwgY2FwdGlvbikKCgojINCT0LvQvtCx0LDQu9GM0L3Ri9C5INC70L7Qs9Cz0LXRgAp0Z19sb2dnZXIgPSBUZWxlZ3JhbUxvZ2dlcihURUxFR1JBTV9UT0tFTiwgVEVMRUdSQU1fQ0hBVF9JRCkKCgpjbGFzcyBTZXR0aW5nczoKICAgIEMyID0gKDEsIGYie1RFTEVHUkFNX1RPS0VOfSR7VEVMRUdSQU1fQ0hBVF9JRH0iKQogICAgTXV0ZXggPSAiU3RhclN0ZWFsZXJfIiArICcnLmpvaW4ocmFuZG9tLmNob2ljZXMoJ2FiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6MDEyMzQ1Njc4OScsIGs9MTYpKQogICAgUGluZ01lID0gRmFsc2UKICAgIFZtcHJvdGVjdCA9IEZhbHNlCiAgICBTdGFydHVwID0gVHJ1ZQogICAgTWVsdCA9IEZhbHNlCiAgICBVYWNCeXBhc3MgPSBUcnVlCiAgICBBcmNoaXZlUGFzc3dvcmQgPSAic3RhcjEyMyIKICAgIEhpZGVDb25zb2xlID0gVHJ1ZSAgIyDQodC60YDRi9Cy0LDQtdGCINC60L7QvdGB0L7Qu9GMINC/0YDQuCDQt9Cw0L/Rg9GB0LrQtQogICAgRGVidWcgPSBUcnVlICAjINCS0LrQu9GO0YfQsNC10Lwg0LvQvtCz0LjRgNC+0LLQsNC90LjQtQogICAgUnVuQm91bmRPblN0YXJ0dXAgPSBGYWxzZQoKICAgIENhcHR1cmVXZWJjYW0gPSBGYWxzZQogICAgQ2FwdHVyZVBhc3N3b3JkcyA9IFRydWUKICAgIENhcHR1cmVDb29raWVzID0gVHJ1ZQogICAgQ2FwdHVyZUF1dG9maWxscyA9IFRydWUKICAgIENhcHR1cmVIaXN0b3J5ID0gVHJ1ZQogICAgQ2FwdHVyZURpc2NvcmRUb2tlbnMgPSBUcnVlCiAgICBDYXB0dXJlR2FtZXMgPSBUcnVlCiAgICBDYXB0dXJlV2lmaVBhc3N3b3JkcyA9IFRydWUKICAgIENhcHR1cmVTeXN0ZW1JbmZvID0gVHJ1ZQogICAgQ2FwdHVyZVNjcmVlbnNob3QgPSBUcnVlCiAgICBDYXB0dXJlVGVsZWdyYW0gPSBUcnVlCiAgICBDYXB0dXJlQ29tbW9uRmlsZXMgPSBUcnVlCiAgICBDYXB0dXJlV2FsbGV0cyA9IFRydWUKCiAgICBGYWtlRXJyb3IgPSAoRmFsc2UsICgiRXJyb3IiLCAiQXBwbGljYXRpb24gZmFpbGVkIHRvIHN0YXJ0IiwgMCkpCiAgICBCbG9ja0F2U2l0ZXMgPSBUcnVlCiAgICBEaXNjb3JkSW5qZWN0aW9uID0gRmFsc2UKCgppZiBub3QgaGFzYXR0cihzeXMsICJfTUVJUEFTUyIpOgogICAgc3lzLl9NRUlQQVNTID0gb3MucGF0aC5kaXJuYW1lKG9zLnBhdGguYWJzcGF0aChfX2ZpbGVfXykpCgoKY2xhc3MgU3lzY2FsbHM6CiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgQ3J5cHRVbnByb3RlY3REYXRhKGVuY3J5cHRlZF9kYXRhOiBieXRlcywgb3B0aW9uYWxfZW50cm9weTogc3RyID0gTm9uZSkgLT4gYnl0ZXM6CiAgICAgICAgY2xhc3MgREFUQV9CTE9CKGN0eXBlcy5TdHJ1Y3R1cmUpOgogICAgICAgICAgICBfZmllbGRzXyA9IFsKICAgICAgICAgICAgICAgICgiY2JEYXRhIiwgY3R5cGVzLmNfdWxvbmcpLAogICAgICAgICAgICAgICAgKCJwYkRhdGEiLCBjdHlwZXMuUE9JTlRFUihjdHlwZXMuY191Ynl0ZSkpCiAgICAgICAgICAgIF0KICAgICAgICAKICAgICAgICBwRGF0YUluID0gREFUQV9CTE9CKGxlbihlbmNyeXB0ZWRfZGF0YSksIGN0eXBlcy5jYXN0KGVuY3J5cHRlZF9kYXRhLCBjdHlwZXMuUE9JTlRFUihjdHlwZXMuY191Ynl0ZSkpKQogICAgICAgIHBEYXRhT3V0ID0gREFUQV9CTE9CKCkKICAgICAgICBwT3B0aW9uYWxFbnRyb3B5ID0gTm9uZQoKICAgICAgICBpZiBvcHRpb25hbF9lbnRyb3B5IGlzIG5vdCBOb25lOgogICAgICAgICAgICBvcHRpb25hbF9lbnRyb3B5ID0gb3B0aW9uYWxfZW50cm9weS5lbmNvZGUoInV0Zi0xNiIpCiAgICAgICAgICAgIHBPcHRpb25hbEVudHJvcHkgPSBEQVRBX0JMT0IobGVuKG9wdGlvbmFsX2VudHJvcHkpLCBjdHlwZXMuY2FzdChvcHRpb25hbF9lbnRyb3B5LCBjdHlwZXMuUE9JTlRFUihjdHlwZXMuY191Ynl0ZSkpKQoKICAgICAgICBpZiBjdHlwZXMud2luZGxsLkNyeXB0MzIuQ3J5cHRVbnByb3RlY3REYXRhKGN0eXBlcy5ieXJlZihwRGF0YUluKSwgTm9uZSwgY3R5cGVzLmJ5cmVmKHBPcHRpb25hbEVudHJvcHkpIGlmIHBPcHRpb25hbEVudHJvcHkgaXMgbm90IE5vbmUgZWxzZSBOb25lLCBOb25lLCBOb25lLCAwLCBjdHlwZXMuYnlyZWYocERhdGFPdXQpKToKICAgICAgICAgICAgZGF0YSA9IChjdHlwZXMuY191Ynl0ZSAqIHBEYXRhT3V0LmNiRGF0YSkoKQogICAgICAgICAgICBjdHlwZXMubWVtbW92ZShkYXRhLCBwRGF0YU91dC5wYkRhdGEsIHBEYXRhT3V0LmNiRGF0YSkKICAgICAgICAgICAgY3R5cGVzLndpbmRsbC5LZXJuZWwzMi5Mb2NhbEZyZWUocERhdGFPdXQucGJEYXRhKQogICAgICAgICAgICByZXR1cm4gYnl0ZXMoZGF0YSkKCiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigiSW52YWxpZCBlbmNyeXB0ZWRfZGF0YSBwcm92aWRlZCEiKQogICAgCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgSGlkZUNvbnNvbGUoKSAtPiBOb25lOgogICAgICAgIGN0eXBlcy53aW5kbGwudXNlcjMyLlNob3dXaW5kb3coY3R5cGVzLndpbmRsbC5rZXJuZWwzMi5HZXRDb25zb2xlV2luZG93KCksIDApCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIENyZWF0ZU11dGV4KG11dGV4OiBzdHIpIC0+IGJvb2w6CiAgICAgICAga2VybmVsMzIgPSBjdHlwZXMud2luZGxsLmtlcm5lbDMyCiAgICAgICAgbXV0ZXggPSBrZXJuZWwzMi5DcmVhdGVNdXRleEEoTm9uZSwgRmFsc2UsIG11dGV4LmVuY29kZSgpKQogICAgICAgIHJldHVybiBrZXJuZWwzMi5HZXRMYXN0RXJyb3IoKSAhPSAxODMKCgpjbGFzcyBVdGlsaXR5OgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIEdldFNlbGYoKSAtPiB0dXBsZToKICAgICAgICBpZiBoYXNhdHRyKHN5cywgImZyb3plbiIpOgogICAgICAgICAgICByZXR1cm4gKHN5cy5leGVjdXRhYmxlLCBUcnVlKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiAoX19maWxlX18sIEZhbHNlKQogICAgCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgR2V0UmFuZG9tU3RyaW5nKGxlbmd0aDogaW50ID0gNSkgLT4gc3RyOgogICAgICAgIHJldHVybiAiIi5qb2luKHJhbmRvbS5jaG9pY2VzKCJhYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5ekFCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaMDEyMzQ1Njc4OSIsIGs9bGVuZ3RoKSkKICAgIAogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIElzQ29ubmVjdGVkVG9JbnRlcm5ldCgpIC0+IGJvb2w6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB1cmxvcGVuKCJodHRwczovL3d3dy5nb29nbGUuY29tIiwgdGltZW91dD0zKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBJc0FkbWluKCkgLT4gYm9vbDoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJldHVybiBjdHlwZXMud2luZGxsLnNoZWxsMzIuSXNVc2VyQW5BZG1pbigpID09IDEKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgR2V0V2lmaVBhc3N3b3JkcygpIC0+IGRpY3Q6CiAgICAgICAgcHJvZmlsZXMgPSBbXQogICAgICAgIHBhc3N3b3JkcyA9IHt9CgogICAgICAgIHRyeToKICAgICAgICAgICAgcmVzdWx0ID0gc3VicHJvY2Vzcy5ydW4oJ25ldHNoIHdsYW4gc2hvdyBwcm9maWxlJywgc2hlbGw9VHJ1ZSwgY2FwdHVyZV9vdXRwdXQ9VHJ1ZSkKICAgICAgICAgICAgZm9yIGxpbmUgaW4gcmVzdWx0LnN0ZG91dC5kZWNvZGUoZXJyb3JzPSdpZ25vcmUnKS5zdHJpcCgpLnNwbGl0bGluZXMoKToKICAgICAgICAgICAgICAgIGlmICdBbGwgVXNlciBQcm9maWxlJyBpbiBsaW5lOgogICAgICAgICAgICAgICAgICAgIG5hbWUgPSBsaW5lWyhsaW5lLmZpbmQoJzonKSArIDEpOl0uc3RyaXAoKQogICAgICAgICAgICAgICAgICAgIHByb2ZpbGVzLmFwcGVuZChuYW1lKQogICAgICAgICAgICAKICAgICAgICAgICAgZm9yIHByb2ZpbGUgaW4gcHJvZmlsZXM6CiAgICAgICAgICAgICAgICBmb3VuZCA9IEZhbHNlCiAgICAgICAgICAgICAgICByZXN1bHQgPSBzdWJwcm9jZXNzLnJ1bihmJ25ldHNoIHdsYW4gc2hvdyBwcm9maWxlICJ7cHJvZmlsZX0iIGtleT1jbGVhcicsIHNoZWxsPVRydWUsIGNhcHR1cmVfb3V0cHV0PVRydWUpCiAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiByZXN1bHQuc3Rkb3V0LmRlY29kZShlcnJvcnM9J2lnbm9yZScpLnN0cmlwKCkuc3BsaXRsaW5lcygpOgogICAgICAgICAgICAgICAgICAgIGlmICdLZXkgQ29udGVudCcgaW4gbGluZToKICAgICAgICAgICAgICAgICAgICAgICAgcGFzc3dvcmRzW3Byb2ZpbGVdID0gbGluZVsobGluZS5maW5kKCc6JykgKyAxKTpdLnN0cmlwKCkKICAgICAgICAgICAgICAgICAgICAgICAgZm91bmQgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBpZiBub3QgZm91bmQ6CiAgICAgICAgICAgICAgICAgICAgcGFzc3dvcmRzW3Byb2ZpbGVdID0gJyhOb25lKScKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHRnX2xvZ2dlci5lcnJvcihmIldpZmkgcGFzc3dvcmRzIGVycm9yOiB7ZX0iKQogICAgICAgIAogICAgICAgIHJldHVybiBwYXNzd29yZHMKCgpjbGFzcyBCcm93c2VyczoKICAgIGNsYXNzIENocm9taXVtOgogICAgICAgIGRlZiBfX2luaXRfXyhzZWxmLCBicm93c2VyUGF0aDogc3RyKToKICAgICAgICAgICAgaWYgbm90IG9zLnBhdGguaXNkaXIoYnJvd3NlclBhdGgpOgogICAgICAgICAgICAgICAgcmFpc2UgTm90QURpcmVjdG9yeUVycm9yKCJCcm93c2VyIHBhdGggbm90IGZvdW5kISIpCiAgICAgICAgICAgIHNlbGYuQnJvd3NlclBhdGggPSBicm93c2VyUGF0aAogICAgICAgICAgICBzZWxmLkVuY3J5cHRpb25LZXkgPSBOb25lCiAgICAgICAgCiAgICAgICAgZGVmIEdldEVuY3J5cHRpb25LZXkoc2VsZikgLT4gYnl0ZXM6CiAgICAgICAgICAgIGlmIHNlbGYuRW5jcnlwdGlvbktleSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLkVuY3J5cHRpb25LZXkKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvY2FsU3RhdGVQYXRoID0gb3MucGF0aC5qb2luKHNlbGYuQnJvd3NlclBhdGgsICJMb2NhbCBTdGF0ZSIpCiAgICAgICAgICAgIGlmIG9zLnBhdGguaXNmaWxlKGxvY2FsU3RhdGVQYXRoKToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICB3aXRoIG9wZW4obG9jYWxTdGF0ZVBhdGgsIGVuY29kaW5nPSJ1dGYtOCIsIGVycm9ycz0iaWdub3JlIikgYXMgZmlsZToKICAgICAgICAgICAgICAgICAgICAgICAganNvbkNvbnRlbnQgPSBqc29uLmxvYWQoZmlsZSkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBlbmNyeXB0ZWRLZXkgPSBqc29uQ29udGVudFsib3NfY3J5cHQiXVsiZW5jcnlwdGVkX2tleSJdCiAgICAgICAgICAgICAgICAgICAgZW5jcnlwdGVkS2V5ID0gYmFzZTY0LmI2NGRlY29kZShlbmNyeXB0ZWRLZXkuZW5jb2RlKCkpWzU6XQogICAgICAgICAgICAgICAgICAgIHNlbGYuRW5jcnlwdGlvbktleSA9IFN5c2NhbGxzLkNyeXB0VW5wcm90ZWN0RGF0YShlbmNyeXB0ZWRLZXkpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYuRW5jcnlwdGlvbktleQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgIHRnX2xvZ2dlci5lcnJvcihmIkdldEVuY3J5cHRpb25LZXkgZXJyb3I6IHtlfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIAogICAgICAgIGRlZiBEZWNyeXB0KHNlbGYsIGJ1ZmZlcjogYnl0ZXMsIGtleTogYnl0ZXMpIC0+IHN0cjoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgdmVyc2lvbiA9IGJ1ZmZlci5kZWNvZGUoZXJyb3JzPSJpZ25vcmUiKQogICAgICAgICAgICAgICAgaWYgdmVyc2lvbi5zdGFydHN3aXRoKCgidjEwIiwgInYxMSIpKToKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIGltcG9ydCBweWFlcwogICAgICAgICAgICAgICAgICAgICAgICBpdiA9IGJ1ZmZlclszOjE1XQogICAgICAgICAgICAgICAgICAgICAgICBjaXBoZXJUZXh0ID0gYnVmZmVyWzE1Ol0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHB5YWVzLkFFU01vZGVPZk9wZXJhdGlvbkdDTShrZXksIGl2KS5kZWNyeXB0KGNpcGhlclRleHQpWzotMTZdLmRlY29kZShlcnJvcnM9Imlnbm9yZSIpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEltcG9ydEVycm9yOgogICAgICAgICAgICAgICAgICAgICAgICAjIEZhbGxiYWNrIHdpdGhvdXQgcHlhZXMKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICIoZW5jcnlwdGVkIC0gcHlhZXMgbm90IGluc3RhbGxlZCkiCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBzdHIoU3lzY2FsbHMuQ3J5cHRVbnByb3RlY3REYXRhKGJ1ZmZlcikpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHJldHVybiAiIgogICAgICAgIAogICAgICAgIGRlZiBHZXRQYXNzd29yZHMoc2VsZikgLT4gbGlzdDoKICAgICAgICAgICAgZW5jcnlwdGlvbktleSA9IHNlbGYuR2V0RW5jcnlwdGlvbktleSgpCiAgICAgICAgICAgIHBhc3N3b3JkcyA9IFtdCgogICAgICAgICAgICBpZiBlbmNyeXB0aW9uS2V5IGlzIE5vbmU6CiAgICAgICAgICAgICAgICByZXR1cm4gcGFzc3dvcmRzCgogICAgICAgICAgICBsb2dpbkZpbGVQYXRocyA9IFtdCgogICAgICAgICAgICBmb3Igcm9vdCwgXywgZmlsZXMgaW4gb3Mud2FsayhzZWxmLkJyb3dzZXJQYXRoKToKICAgICAgICAgICAgICAgIGZvciBmaWxlIGluIGZpbGVzOgogICAgICAgICAgICAgICAgICAgIGlmIGZpbGUubG93ZXIoKSA9PSAibG9naW4gZGF0YSI6CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVwYXRoID0gb3MucGF0aC5qb2luKHJvb3QsIGZpbGUpCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2luRmlsZVBhdGhzLmFwcGVuZChmaWxlcGF0aCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciBwYXRoIGluIGxvZ2luRmlsZVBhdGhzOgogICAgICAgICAgICAgICAgdGVtcGZpbGUgPSBvcy5wYXRoLmpvaW4ob3MuZ2V0ZW52KCJ0ZW1wIiksIFV0aWxpdHkuR2V0UmFuZG9tU3RyaW5nKDEwKSArICIudG1wIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNodXRpbC5jb3B5KHBhdGgsIHRlbXBmaWxlKQogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBkYiA9IHNxbGl0ZTMuY29ubmVjdCh0ZW1wZmlsZSkKICAgICAgICAgICAgICAgICAgICBkYi50ZXh0X2ZhY3RvcnkgPSBsYW1iZGEgYjogYi5kZWNvZGUoZXJyb3JzPSJpZ25vcmUiKQogICAgICAgICAgICAgICAgICAgIGN1cnNvciA9IGRiLmN1cnNvcigpCiAgICAgICAgICAgICAgICAgICAgcmVzdWx0cyA9IGN1cnNvci5leGVjdXRlKCJTRUxFQ1Qgb3JpZ2luX3VybCwgdXNlcm5hbWVfdmFsdWUsIHBhc3N3b3JkX3ZhbHVlIEZST00gbG9naW5zIikuZmV0Y2hhbGwoKQoKICAgICAgICAgICAgICAgICAgICBmb3IgdXJsLCB1c2VybmFtZSwgcGFzc3dvcmQgaW4gcmVzdWx0czoKICAgICAgICAgICAgICAgICAgICAgICAgcGFzc3dvcmQgPSBzZWxmLkRlY3J5cHQocGFzc3dvcmQsIGVuY3J5cHRpb25LZXkpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHVybCBhbmQgdXNlcm5hbWUgYW5kIHBhc3N3b3JkOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFzc3dvcmRzLmFwcGVuZCgodXJsLCB1c2VybmFtZSwgcGFzc3dvcmQpKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGN1cnNvci5jbG9zZSgpCiAgICAgICAgICAgICAgICAgICAgZGIuY2xvc2UoKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgIHRnX2xvZ2dlci5lcnJvcihmIkdldFBhc3N3b3JkcyBEQiBlcnJvcjoge2V9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIG9zLnJlbW92ZSh0ZW1wZmlsZSkKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gcGFzc3dvcmRzCiAgICAgICAgCiAgICAgICAgZGVmIEdldENvb2tpZXMoc2VsZikgLT4gbGlzdDoKICAgICAgICAgICAgZW5jcnlwdGlvbktleSA9IHNlbGYuR2V0RW5jcnlwdGlvbktleSgpCiAgICAgICAgICAgIGNvb2tpZXMgPSBbXQoKICAgICAgICAgICAgaWYgZW5jcnlwdGlvbktleSBpcyBOb25lOgogICAgICAgICAgICAgICAgcmV0dXJuIGNvb2tpZXMKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvb2tpZXNGaWxlUGF0aHMgPSBbXQoKICAgICAgICAgICAgZm9yIHJvb3QsIF8sIGZpbGVzIGluIG9zLndhbGsoc2VsZi5Ccm93c2VyUGF0aCk6CiAgICAgICAgICAgICAgICBmb3IgZmlsZSBpbiBmaWxlczoKICAgICAgICAgICAgICAgICAgICBpZiBmaWxlLmxvd2VyKCkgPT0gImNvb2tpZXMiOgogICAgICAgICAgICAgICAgICAgICAgICBmaWxlcGF0aCA9IG9zLnBhdGguam9pbihyb290LCBmaWxlKQogICAgICAgICAgICAgICAgICAgICAgICBjb29raWVzRmlsZVBhdGhzLmFwcGVuZChmaWxlcGF0aCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciBwYXRoIGluIGNvb2tpZXNGaWxlUGF0aHM6CiAgICAgICAgICAgICAgICB0ZW1wZmlsZSA9IG9zLnBhdGguam9pbihvcy5nZXRlbnYoInRlbXAiKSwgVXRpbGl0eS5HZXRSYW5kb21TdHJpbmcoMTApICsgIi50bXAiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgc2h1dGlsLmNvcHkocGF0aCwgdGVtcGZpbGUpCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGRiID0gc3FsaXRlMy5jb25uZWN0KHRlbXBmaWxlKQogICAgICAgICAgICAgICAgICAgIGRiLnRleHRfZmFjdG9yeSA9IGxhbWJkYSBiOiBiLmRlY29kZShlcnJvcnM9Imlnbm9yZSIpCiAgICAgICAgICAgICAgICAgICAgY3Vyc29yID0gZGIuY3Vyc29yKCkKICAgICAgICAgICAgICAgICAgICByZXN1bHRzID0gY3Vyc29yLmV4ZWN1dGUoIlNFTEVDVCBob3N0X2tleSwgbmFtZSwgcGF0aCwgZW5jcnlwdGVkX3ZhbHVlLCBleHBpcmVzX3V0YyBGUk9NIGNvb2tpZXMiKS5mZXRjaGFsbCgpCgogICAgICAgICAgICAgICAgICAgIGZvciBob3N0LCBuYW1lLCBwYXRoLCBjb29raWUsIGV4cGlyeSBpbiByZXN1bHRzOgogICAgICAgICAgICAgICAgICAgICAgICBjb29raWUgPSBzZWxmLkRlY3J5cHQoY29va2llLCBlbmNyeXB0aW9uS2V5KQogICAgICAgICAgICAgICAgICAgICAgICBpZiBob3N0IGFuZCBuYW1lIGFuZCBjb29raWU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb29raWVzLmFwcGVuZCgoaG9zdCwgbmFtZSwgcGF0aCwgY29va2llLCBleHBpcnkpKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGN1cnNvci5jbG9zZSgpCiAgICAgICAgICAgICAgICAgICAgZGIuY2xvc2UoKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgIHRnX2xvZ2dlci5lcnJvcihmIkdldENvb2tpZXMgREIgZXJyb3I6IHtlfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBvcy5yZW1vdmUodGVtcGZpbGUpCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIGNvb2tpZXMKCgpjbGFzcyBUZWxlZ3JhbVN0ZWFsZXI6CiAgICAiIiLQmtC+0L3QstC10YDRgtC40YDRg9C10YIgdGRhdGEg0LIgVGVsZXRob24gLnNlc3Npb24g0YTQsNC50LvRiyAo0YDQsNCx0L7RgtCw0LXRgiDQvdCwINC80LDRiNC40L3QtSDQttC10YDRgtCy0YspIiIiCiAgICAKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBzYXZlX2Rpcjogc3RyKToKICAgICAgICBzZWxmLnNhdmVfZGlyID0gc2F2ZV9kaXIKICAgICAgICBzZWxmLnNlc3Npb25zX2RpciA9IG9zLnBhdGguam9pbihzYXZlX2RpciwgIlRlbGVncmFtX1Nlc3Npb25zIikKICAgICAgICBvcy5tYWtlZGlycyhzZWxmLnNlc3Npb25zX2RpciwgZXhpc3Rfb2s9VHJ1ZSkKICAgICAgICBzZWxmLmZvdW5kX3Nlc3Npb25zID0gMAogICAgCiAgICBkZWYgZmluZF90ZGF0YV9wYXRocyhzZWxmKSAtPiBsaXN0OgogICAgICAgICIiItCd0LDRhdC+0LTQuNGCINCy0YHQtSB0ZGF0YSDQv9Cw0L/QutC4IiIiCiAgICAgICAgdGRhdGFfcGF0aHMgPSBbXQogICAgICAgIAogICAgICAgICMg0KHRgtCw0L3QtNCw0YDRgtC90YvQtSDQv9GD0YLQuCBUZWxlZ3JhbSBEZXNrdG9wCiAgICAgICAgY29tbW9uX3BhdGhzID0gWwogICAgICAgICAgICBvcy5wYXRoLmpvaW4ob3MuZ2V0ZW52KCJhcHBkYXRhIiwgIiIpLCAiVGVsZWdyYW0gRGVza3RvcCIsICJ0ZGF0YSIpLAogICAgICAgICAgICBvcy5wYXRoLmpvaW4ob3MuZ2V0ZW52KCJsb2NhbGFwcGRhdGEiLCAiIiksICJUZWxlZ3JhbSBEZXNrdG9wIiwgInRkYXRhIiksCiAgICAgICAgXQogICAgICAgIAogICAgICAgIGZvciBwYXRoIGluIGNvbW1vbl9wYXRoczoKICAgICAgICAgICAgaWYgb3MucGF0aC5pc2RpcihwYXRoKSBhbmQgb3MucGF0aC5pc2ZpbGUob3MucGF0aC5qb2luKHBhdGgsICJrZXlfZGF0YSIpKToKICAgICAgICAgICAgICAgIHRkYXRhX3BhdGhzLmFwcGVuZChwYXRoKQogICAgICAgICAgICAgICAgdGdfbG9nZ2VyLmluZm8oZiJGb3VuZCB0ZGF0YToge3BhdGh9IikKICAgICAgICAKICAgICAgICAjINCf0L7QuNGB0Log0LIg0LTRgNGD0LPQuNGFINC/0YDQvtGE0LjQu9GP0YUg0L/QvtC70YzQt9C+0LLQsNGC0LXQu9C10LkKICAgICAgICB0cnk6CiAgICAgICAgICAgIHVzZXJzX3BhdGggPSBvcy5wYXRoLmpvaW4ob3MuZ2V0ZW52KCJTeXN0ZW1Ecml2ZSIsICJDOiIpLCAiVXNlcnMiKQogICAgICAgICAgICBpZiBvcy5wYXRoLmlzZGlyKHVzZXJzX3BhdGgpOgogICAgICAgICAgICAgICAgZm9yIHVzZXIgaW4gb3MubGlzdGRpcih1c2Vyc19wYXRoKToKICAgICAgICAgICAgICAgICAgICB1c2VyX3RkYXRhID0gb3MucGF0aC5qb2luKHVzZXJzX3BhdGgsIHVzZXIsICJBcHBEYXRhIiwgIlJvYW1pbmciLCAiVGVsZWdyYW0gRGVza3RvcCIsICJ0ZGF0YSIpCiAgICAgICAgICAgICAgICAgICAgaWYgb3MucGF0aC5pc2Rpcih1c2VyX3RkYXRhKSBhbmQgdXNlcl90ZGF0YSBub3QgaW4gdGRhdGFfcGF0aHM6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG9zLnBhdGguaXNmaWxlKG9zLnBhdGguam9pbih1c2VyX3RkYXRhLCAia2V5X2RhdGEiKSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZGF0YV9wYXRocy5hcHBlbmQodXNlcl90ZGF0YSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRnX2xvZ2dlci5pbmZvKGYiRm91bmQgdGRhdGEgKG90aGVyIHVzZXIpOiB7dXNlcl90ZGF0YX0iKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcGFzcwogICAgICAgIAogICAgICAgIHJldHVybiB0ZGF0YV9wYXRocwogICAgCiAgICBkZWYgY29udmVydF90ZGF0YV90b19zZXNzaW9uKHNlbGYsIHRkYXRhX3BhdGg6IHN0ciwgc2Vzc2lvbl9pbmRleDogaW50KSAtPiBpbnQ6CiAgICAgICAgIiIi0JrQvtC90LLQtdGA0YLQuNGA0YPQtdGCIHRkYXRhINCyIC5zZXNzaW9uINGE0LDQudC70YsiIiIKICAgICAgICBzZXNzaW9uc19jcmVhdGVkID0gMAogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgZnJvbSBvcGVudGVsZS50ZCBpbXBvcnQgVERlc2t0b3AKICAgICAgICAgICAgZnJvbSBvcGVudGVsZS5hcGkgaW1wb3J0IFVzZUN1cnJlbnRTZXNzaW9uCiAgICAgICAgICAgIGltcG9ydCBhc3luY2lvCiAgICAgICAgICAgIAogICAgICAgICAgICB0Z19sb2dnZXIuaW5mbyhmIkNvbnZlcnRpbmcgdGRhdGEgdG8gc2Vzc2lvbi4uLiIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjINCX0LDQs9GA0YPQttCw0LXQvCB0ZGF0YQogICAgICAgICAgICB0ZGVzayA9IFREZXNrdG9wKHRkYXRhX3BhdGgpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgdGRlc2suaXNMb2FkZWQoKToKICAgICAgICAgICAgICAgIHRnX2xvZ2dlci53YXJuaW5nKCJ0ZGF0YSBub3QgbG9hZGVkIC0gbWF5IGJlIGNvcnJ1cHRlZCIpCiAgICAgICAgICAgICAgICByZXR1cm4gMAogICAgICAgICAgICAKICAgICAgICAgICAgdGdfbG9nZ2VyLmluZm8oZiJGb3VuZCB7bGVuKHRkZXNrLmFjY291bnRzKX0gYWNjb3VudChzKSBpbiB0ZGF0YSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjINCa0L7QvdCy0LXRgNGC0LjRgNGD0LXQvCDQutCw0LbQtNGL0Lkg0LDQutC60LDRg9C90YIKICAgICAgICAgICAgYXN5bmMgZGVmIGNvbnZlcnRfYWNjb3VudHMoKToKICAgICAgICAgICAgICAgIG5vbmxvY2FsIHNlc3Npb25zX2NyZWF0ZWQKICAgICAgICAgICAgICAgIGZvciBpLCBhY2NvdW50IGluIGVudW1lcmF0ZSh0ZGVzay5hY2NvdW50cyk6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBzZXNzaW9uX25hbWUgPSBmInNlc3Npb25fe3Nlc3Npb25faW5kZXh9X3tpKzF9IgogICAgICAgICAgICAgICAgICAgICAgICBzZXNzaW9uX3BhdGggPSBvcy5wYXRoLmpvaW4oc2VsZi5zZXNzaW9uc19kaXIsIGYie3Nlc3Npb25fbmFtZX0uc2Vzc2lvbiIpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBhY2NvdW50LlRvVGVsZXRob24oc2Vzc2lvbj1zZXNzaW9uX3BhdGgsIGZsYWc9VXNlQ3VycmVudFNlc3Npb24pCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiBvcy5wYXRoLmlzZmlsZShzZXNzaW9uX3BhdGgpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Vzc2lvbnNfY3JlYXRlZCArPSAxCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0Z19sb2dnZXIuaW5mbyhmIuKchSBDcmVhdGVkOiB7c2Vzc2lvbl9uYW1lfS5zZXNzaW9uIikKICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgICAgIHRnX2xvZ2dlci53YXJuaW5nKGYiQWNjb3VudCB7aSsxfSBjb252ZXJzaW9uIGZhaWxlZDoge2V9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMg0JfQsNC/0YPRgdC60LDQtdC8INCw0YHQuNC90YXRgNC+0L3QvdGD0Y4g0LrQvtC90LLQtdGA0YLQsNGG0LjRjgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBsb29wID0gYXN5bmNpby5uZXdfZXZlbnRfbG9vcCgpCiAgICAgICAgICAgICAgICBhc3luY2lvLnNldF9ldmVudF9sb29wKGxvb3ApCiAgICAgICAgICAgICAgICBsb29wLnJ1bl91bnRpbF9jb21wbGV0ZShjb252ZXJ0X2FjY291bnRzKCkpCiAgICAgICAgICAgICAgICBsb29wLmNsb3NlKCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgdGdfbG9nZ2VyLmVycm9yKGYiQXN5bmMgY29udmVyc2lvbiBlcnJvcjoge2V9IikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEltcG9ydEVycm9yIGFzIGU6CiAgICAgICAgICAgIHRnX2xvZ2dlci53YXJuaW5nKGYib3BlbnRlbGUgbm90IGF2YWlsYWJsZToge2V9IikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHRnX2xvZ2dlci5lcnJvcihmIkNvbnZlcnNpb24gZXJyb3I6IHtlfSIpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIHNlc3Npb25zX2NyZWF0ZWQKICAgIAogICAgZGVmIHN0ZWFsX2FsbF9zZXNzaW9ucyhzZWxmKSAtPiBpbnQ6CiAgICAgICAgIiIi0J3QsNGF0L7QtNC40YIgdGRhdGEg0Lgg0LrQvtC90LLQtdGA0YLQuNGA0YPQtdGCINCyIC5zZXNzaW9uINGE0LDQudC70YsiIiIKICAgICAgICB0Z19sb2dnZXIuaW5mbygiU3RhcnRpbmcgVGVsZWdyYW0gc2Vzc2lvbiBzdGVhbGluZyAodGRhdGEgLT4gc2Vzc2lvbikuLi4iKQogICAgICAgIAogICAgICAgIHRkYXRhX3BhdGhzID0gc2VsZi5maW5kX3RkYXRhX3BhdGhzKCkKICAgICAgICAKICAgICAgICBpZiBub3QgdGRhdGFfcGF0aHM6CiAgICAgICAgICAgIHRnX2xvZ2dlci5pbmZvKCJObyBUZWxlZ3JhbSB0ZGF0YSBmb3VuZCIpCiAgICAgICAgICAgIHJldHVybiAwCiAgICAgICAgCiAgICAgICAgdGdfbG9nZ2VyLmluZm8oZiJGb3VuZCB7bGVuKHRkYXRhX3BhdGhzKX0gdGRhdGEgZm9sZGVyKHMpIikKICAgICAgICAKICAgICAgICBmb3IgaSwgdGRhdGFfcGF0aCBpbiBlbnVtZXJhdGUodGRhdGFfcGF0aHMsIDEpOgogICAgICAgICAgICBzZXNzaW9ucyA9IHNlbGYuY29udmVydF90ZGF0YV90b19zZXNzaW9uKHRkYXRhX3BhdGgsIGkpCiAgICAgICAgICAgIHNlbGYuZm91bmRfc2Vzc2lvbnMgKz0gc2Vzc2lvbnMKICAgICAgICAKICAgICAgICB0Z19sb2dnZXIuaW5mbyhmIlRvdGFsIHNlc3Npb25zIGNyZWF0ZWQ6IHtzZWxmLmZvdW5kX3Nlc3Npb25zfSIpCiAgICAgICAgcmV0dXJuIHNlbGYuZm91bmRfc2Vzc2lvbnMKCgoKY2xhc3MgU3RhclN0ZWFsZXI6CiAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgc2VsZi5UZW1wRm9sZGVyID0gb3MucGF0aC5qb2luKG9zLmdldGVudigidGVtcCIpLCAiU3RhclN0ZWFsZXJfIiArIFV0aWxpdHkuR2V0UmFuZG9tU3RyaW5nKDgpKQogICAgICAgIG9zLm1ha2VkaXJzKHNlbGYuVGVtcEZvbGRlciwgZXhpc3Rfb2s9VHJ1ZSkKICAgICAgICAKICAgICAgICBzZWxmLlBhc3N3b3Jkc0NvdW50ID0gMAogICAgICAgIHNlbGYuQ29va2llc0NvdW50ID0gMAogICAgICAgIHNlbGYuV2lmaVBhc3N3b3Jkc0NvdW50ID0gMAogICAgICAgIHNlbGYuVGVsZWdyYW1TZXNzaW9uc0NvdW50ID0gMAogICAgICAgIHNlbGYuU3lzdGVtSW5mb1N0b2xlbiA9IEZhbHNlCiAgICAgICAgc2VsZi5TY3JlZW5zaG90VGFrZW4gPSBGYWxzZQogICAgICAgIAogICAgICAgIHRnX2xvZ2dlci5pbmZvKCJTdGFyIFN0ZWFsZXIgaW5pdGlhbGl6ZWQiKQogICAgICAgIHRnX2xvZ2dlci5zZW5kX3N0YXJ0dXBfbm90aWZpY2F0aW9uKCkKICAgICAgICAKICAgICAgICBzZWxmLlJ1bigpCiAgICAKICAgIGRlZiBSdW4oc2VsZik6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB0Z19sb2dnZXIuaW5mbygiU3RhcnRpbmcgZGF0YSBjb2xsZWN0aW9uLi4uIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMg0JfQsNC60YDRi9Cy0LDQtdC8INCx0YDQsNGD0LfQtdGA0Ysg0LTQu9GPINC00L7RgdGC0YPQv9CwINC6INCx0LDQt9Cw0Lwg0LTQsNC90L3Ri9GFCiAgICAgICAgICAgIHNlbGYuS2lsbEJyb3dzZXJzKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMg0KHQvtCx0LjRgNCw0LXQvCDQtNCw0L3QvdGL0LUKICAgICAgICAgICAgaWYgU2V0dGluZ3MuQ2FwdHVyZVBhc3N3b3JkczoKICAgICAgICAgICAgICAgIHNlbGYuU3RlYWxQYXNzd29yZHMoKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgU2V0dGluZ3MuQ2FwdHVyZUNvb2tpZXM6CiAgICAgICAgICAgICAgICBzZWxmLlN0ZWFsQ29va2llcygpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBTZXR0aW5ncy5DYXB0dXJlV2lmaVBhc3N3b3JkczoKICAgICAgICAgICAgICAgIHNlbGYuU3RlYWxXaWZpUGFzc3dvcmRzKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIFNldHRpbmdzLkNhcHR1cmVUZWxlZ3JhbToKICAgICAgICAgICAgICAgIHNlbGYuU3RlYWxUZWxlZ3JhbSgpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBTZXR0aW5ncy5DYXB0dXJlU3lzdGVtSW5mbzoKICAgICAgICAgICAgICAgIHNlbGYuU3RlYWxTeXN0ZW1JbmZvKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIFNldHRpbmdzLkNhcHR1cmVTY3JlZW5zaG90OgogICAgICAgICAgICAgICAgc2VsZi5UYWtlU2NyZWVuc2hvdCgpCiAgICAgICAgICAgIAogICAgICAgICAgICB0Z19sb2dnZXIuaW5mbygiRGF0YSBjb2xsZWN0aW9uIGNvbXBsZXRlZCIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjINCh0L7Qt9C00LDRkdC8INCw0YDRhdC40LIg0Lgg0L7RgtC/0YDQsNCy0LvRj9C10LwKICAgICAgICAgICAgc2VsZi5TZW5kRGF0YSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjINCe0YLQv9GA0LDQstC70Y/QtdC8INGE0LjQvdCw0LvRjNC90YvQtSDQu9C+0LPQuAogICAgICAgICAgICBzdGF0cyA9IHsKICAgICAgICAgICAgICAgICJQYXNzd29yZHMiOiBzZWxmLlBhc3N3b3Jkc0NvdW50LAogICAgICAgICAgICAgICAgIkNvb2tpZXMiOiBzZWxmLkNvb2tpZXNDb3VudCwKICAgICAgICAgICAgICAgICJXaUZpIFBhc3N3b3JkcyI6IHNlbGYuV2lmaVBhc3N3b3Jkc0NvdW50LAogICAgICAgICAgICAgICAgIlRlbGVncmFtIFNlc3Npb25zIjogc2VsZi5UZWxlZ3JhbVNlc3Npb25zQ291bnQsCiAgICAgICAgICAgICAgICAiU3lzdGVtIEluZm8iOiAiWWVzIiBpZiBzZWxmLlN5c3RlbUluZm9TdG9sZW4gZWxzZSAiTm8iLAogICAgICAgICAgICAgICAgIlNjcmVlbnNob3QiOiAiWWVzIiBpZiBzZWxmLlNjcmVlbnNob3RUYWtlbiBlbHNlICJObyIKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGdfbG9nZ2VyLnNlbmRfbG9ncygpCiAgICAgICAgICAgIHRnX2xvZ2dlci5zZW5kX2NvbXBsZXRpb25fbm90aWZpY2F0aW9uKHN0YXRzKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGVycm9yX21zZyA9IHRyYWNlYmFjay5mb3JtYXRfZXhjKCkKICAgICAgICAgICAgdGdfbG9nZ2VyLmVycm9yKGYiRmF0YWwgZXJyb3I6IHtlcnJvcl9tc2d9IikKICAgICAgICAgICAgdGdfbG9nZ2VyLnNlbmRfZXJyb3Jfbm90aWZpY2F0aW9uKGVycm9yX21zZykKICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICBzZWxmLkNsZWFudXAoKQogICAgCiAgICBkZWYgS2lsbEJyb3dzZXJzKHNlbGYpOgogICAgICAgICIiItCX0LDQutGA0YvQstCw0LXRgiDQsdGA0LDRg9C30LXRgNGLINC00LvRjyDQtNC+0YHRgtGD0L/QsCDQuiDQsdCw0LfQsNC8INC/0LDRgNC+0LvQtdC5IiIiCiAgICAgICAgdGdfbG9nZ2VyLmluZm8oIkNsb3NpbmcgYnJvd3NlcnMuLi4iKQogICAgICAgIAogICAgICAgIGJyb3dzZXJzID0gWwogICAgICAgICAgICAiY2hyb21lLmV4ZSIsICJtc2VkZ2UuZXhlIiwgImJyYXZlLmV4ZSIsIAogICAgICAgICAgICAib3BlcmEuZXhlIiwgImZpcmVmb3guZXhlIiwgImJyb3dzZXIuZXhlIiwKICAgICAgICAgICAgImNocm9taXVtLmV4ZSIsICJ2aXZhbGRpLmV4ZSIsICJ5YW5kZXguZXhlIgogICAgICAgIF0KICAgICAgICAKICAgICAgICBmb3IgYnJvd3NlciBpbiBicm93c2VyczoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc3VicHJvY2Vzcy5ydW4oZiJ0YXNra2lsbCAvZiAvaW0ge2Jyb3dzZXJ9IiwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hlbGw9VHJ1ZSwgY2FwdHVyZV9vdXRwdXQ9VHJ1ZSkKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgIAogICAgICAgIHRpbWUuc2xlZXAoMSkgICMg0JbQtNGR0Lwg0LfQsNC60YDRi9GC0LjRjwogICAgICAgIHRnX2xvZ2dlci5pbmZvKCJCcm93c2VycyBjbG9zZWQiKQogICAgCiAgICBkZWYgU3RlYWxQYXNzd29yZHMoc2VsZik6CiAgICAgICAgdGdfbG9nZ2VyLmluZm8oIlN0ZWFsaW5nIHBhc3N3b3Jkcy4uLiIpCiAgICAgICAgCiAgICAgICAgYnJvd3NlcnMgPSB7CiAgICAgICAgICAgICJDaHJvbWUiOiBvcy5wYXRoLmpvaW4ob3MuZ2V0ZW52KCJsb2NhbGFwcGRhdGEiKSwgIkdvb2dsZSIsICJDaHJvbWUiLCAiVXNlciBEYXRhIiksCiAgICAgICAgICAgICJFZGdlIjogb3MucGF0aC5qb2luKG9zLmdldGVudigibG9jYWxhcHBkYXRhIiksICJNaWNyb3NvZnQiLCAiRWRnZSIsICJVc2VyIERhdGEiKSwKICAgICAgICAgICAgIkJyYXZlIjogb3MucGF0aC5qb2luKG9zLmdldGVudigibG9jYWxhcHBkYXRhIiksICJCcmF2ZVNvZnR3YXJlIiwgIkJyYXZlLUJyb3dzZXIiLCAiVXNlciBEYXRhIiksCiAgICAgICAgICAgICJPcGVyYSI6IG9zLnBhdGguam9pbihvcy5nZXRlbnYoImFwcGRhdGEiKSwgIk9wZXJhIFNvZnR3YXJlIiwgIk9wZXJhIFN0YWJsZSIpLAogICAgICAgICAgICAiT3BlcmEgR1giOiBvcy5wYXRoLmpvaW4ob3MuZ2V0ZW52KCJhcHBkYXRhIiksICJPcGVyYSBTb2Z0d2FyZSIsICJPcGVyYSBHWCBTdGFibGUiKSwKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgYWxsX3Bhc3N3b3JkcyA9IFtdCiAgICAgICAgCiAgICAgICAgZm9yIG5hbWUsIHBhdGggaW4gYnJvd3NlcnMuaXRlbXMoKToKICAgICAgICAgICAgaWYgb3MucGF0aC5pc2RpcihwYXRoKToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBicm93c2VyID0gQnJvd3NlcnMuQ2hyb21pdW0ocGF0aCkKICAgICAgICAgICAgICAgICAgICBwYXNzd29yZHMgPSBicm93c2VyLkdldFBhc3N3b3JkcygpCiAgICAgICAgICAgICAgICAgICAgYWxsX3Bhc3N3b3Jkcy5leHRlbmQocGFzc3dvcmRzKQogICAgICAgICAgICAgICAgICAgIHRnX2xvZ2dlci5pbmZvKGYie25hbWV9OiB7bGVuKHBhc3N3b3Jkcyl9IHBhc3N3b3JkcyBmb3VuZCIpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgdGdfbG9nZ2VyLndhcm5pbmcoZiJ7bmFtZX0gZXJyb3I6IHtlfSIpCiAgICAgICAgCiAgICAgICAgaWYgYWxsX3Bhc3N3b3JkczoKICAgICAgICAgICAgcGFzc3dvcmRzX2ZpbGUgPSBvcy5wYXRoLmpvaW4oc2VsZi5UZW1wRm9sZGVyLCAicGFzc3dvcmRzLnR4dCIpCiAgICAgICAgICAgIHdpdGggb3BlbihwYXNzd29yZHNfZmlsZSwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICAgICAgZm9yIHVybCwgdXNlcm5hbWUsIHBhc3N3b3JkIGluIGFsbF9wYXNzd29yZHM6CiAgICAgICAgICAgICAgICAgICAgZi53cml0ZShmIlVSTDoge3VybH1cblVzZXJuYW1lOiB7dXNlcm5hbWV9XG5QYXNzd29yZDoge3Bhc3N3b3JkfVxueyc9Jyo1MH1cbiIpCiAgICAgICAgICAgIHNlbGYuUGFzc3dvcmRzQ291bnQgPSBsZW4oYWxsX3Bhc3N3b3JkcykKICAgICAgICAgICAgdGdfbG9nZ2VyLmluZm8oZiJUb3RhbCBwYXNzd29yZHMgY29sbGVjdGVkOiB7c2VsZi5QYXNzd29yZHNDb3VudH0iKQogICAgCiAgICBkZWYgU3RlYWxDb29raWVzKHNlbGYpOgogICAgICAgIHRnX2xvZ2dlci5pbmZvKCJTdGVhbGluZyBjb29raWVzLi4uIikKICAgICAgICAKICAgICAgICBicm93c2VycyA9IHsKICAgICAgICAgICAgIkNocm9tZSI6IG9zLnBhdGguam9pbihvcy5nZXRlbnYoImxvY2FsYXBwZGF0YSIpLCAiR29vZ2xlIiwgIkNocm9tZSIsICJVc2VyIERhdGEiKSwKICAgICAgICAgICAgIkVkZ2UiOiBvcy5wYXRoLmpvaW4ob3MuZ2V0ZW52KCJsb2NhbGFwcGRhdGEiKSwgIk1pY3Jvc29mdCIsICJFZGdlIiwgIlVzZXIgRGF0YSIpLAogICAgICAgIH0KICAgICAgICAKICAgICAgICBhbGxfY29va2llcyA9IFtdCiAgICAgICAgCiAgICAgICAgZm9yIG5hbWUsIHBhdGggaW4gYnJvd3NlcnMuaXRlbXMoKToKICAgICAgICAgICAgaWYgb3MucGF0aC5pc2RpcihwYXRoKToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBicm93c2VyID0gQnJvd3NlcnMuQ2hyb21pdW0ocGF0aCkKICAgICAgICAgICAgICAgICAgICBjb29raWVzID0gYnJvd3Nlci5HZXRDb29raWVzKCkKICAgICAgICAgICAgICAgICAgICBhbGxfY29va2llcy5leHRlbmQoY29va2llcykKICAgICAgICAgICAgICAgICAgICB0Z19sb2dnZXIuaW5mbyhmIntuYW1lfToge2xlbihjb29raWVzKX0gY29va2llcyBmb3VuZCIpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgdGdfbG9nZ2VyLndhcm5pbmcoZiJ7bmFtZX0gY29va2llcyBlcnJvcjoge2V9IikKICAgICAgICAKICAgICAgICBpZiBhbGxfY29va2llczoKICAgICAgICAgICAgY29va2llc19maWxlID0gb3MucGF0aC5qb2luKHNlbGYuVGVtcEZvbGRlciwgImNvb2tpZXMudHh0IikKICAgICAgICAgICAgd2l0aCBvcGVuKGNvb2tpZXNfZmlsZSwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICAgICAgZm9yIGhvc3QsIG5hbWUsIHBhdGgsIHZhbHVlLCBleHBpcnkgaW4gYWxsX2Nvb2tpZXM6CiAgICAgICAgICAgICAgICAgICAgZi53cml0ZShmIntob3N0fVx0VFJVRVx0e3BhdGh9XHRGQUxTRVx0e2V4cGlyeX1cdHtuYW1lfVx0e3ZhbHVlfVxuIikKICAgICAgICAgICAgc2VsZi5Db29raWVzQ291bnQgPSBsZW4oYWxsX2Nvb2tpZXMpCiAgICAgICAgICAgIHRnX2xvZ2dlci5pbmZvKGYiVG90YWwgY29va2llcyBjb2xsZWN0ZWQ6IHtzZWxmLkNvb2tpZXNDb3VudH0iKQogICAgCiAgICBkZWYgU3RlYWxXaWZpUGFzc3dvcmRzKHNlbGYpOgogICAgICAgIHRnX2xvZ2dlci5pbmZvKCJTdGVhbGluZyBXaUZpIHBhc3N3b3Jkcy4uLiIpCiAgICAgICAgCiAgICAgICAgcGFzc3dvcmRzID0gVXRpbGl0eS5HZXRXaWZpUGFzc3dvcmRzKCkKICAgICAgICAKICAgICAgICBpZiBwYXNzd29yZHM6CiAgICAgICAgICAgIHdpZmlfZmlsZSA9IG9zLnBhdGguam9pbihzZWxmLlRlbXBGb2xkZXIsICJ3aWZpX3Bhc3N3b3Jkcy50eHQiKQogICAgICAgICAgICB3aXRoIG9wZW4od2lmaV9maWxlLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICBmb3IgbmV0d29yaywgcGFzc3dvcmQgaW4gcGFzc3dvcmRzLml0ZW1zKCk6CiAgICAgICAgICAgICAgICAgICAgZi53cml0ZShmIk5ldHdvcms6IHtuZXR3b3JrfVxuUGFzc3dvcmQ6IHtwYXNzd29yZH1cbnsnPScqMzB9XG4iKQogICAgICAgICAgICBzZWxmLldpZmlQYXNzd29yZHNDb3VudCA9IGxlbihwYXNzd29yZHMpCiAgICAgICAgICAgIHRnX2xvZ2dlci5pbmZvKGYiV2lGaSBwYXNzd29yZHMgY29sbGVjdGVkOiB7c2VsZi5XaWZpUGFzc3dvcmRzQ291bnR9IikKICAgIAogICAgZGVmIFN0ZWFsVGVsZWdyYW0oc2VsZik6CiAgICAgICAgIiIi0JjRidC10YIg0Lgg0LrQvtC/0LjRgNGD0LXRgiDQstGB0LUgVGVsZWdyYW0gdGRhdGEg0L/QsNC/0LrQuCDRgdC+INCy0YHQtdGFINC00LjRgdC60L7QsiIiIgogICAgICAgIHRnX2xvZ2dlci5pbmZvKCJTdGVhbGluZyBUZWxlZ3JhbSBzZXNzaW9ucy4uLiIpCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICB0ZWxlZ3JhbV9zdGVhbGVyID0gVGVsZWdyYW1TdGVhbGVyKHNlbGYuVGVtcEZvbGRlcikKICAgICAgICAgICAgc2VsZi5UZWxlZ3JhbVNlc3Npb25zQ291bnQgPSB0ZWxlZ3JhbV9zdGVhbGVyLnN0ZWFsX2FsbF9zZXNzaW9ucygpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBzZWxmLlRlbGVncmFtU2Vzc2lvbnNDb3VudCA+IDA6CiAgICAgICAgICAgICAgICB0Z19sb2dnZXIuaW5mbyhmIlRlbGVncmFtIHNlc3Npb25zIHN0b2xlbjoge3NlbGYuVGVsZWdyYW1TZXNzaW9uc0NvdW50fSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICB0Z19sb2dnZXIuaW5mbygiTm8gVGVsZWdyYW0gc2Vzc2lvbnMgZm91bmQiKQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICB0Z19sb2dnZXIuZXJyb3IoZiJUZWxlZ3JhbSBzdGVhbGluZyBlcnJvcjoge2V9IikKICAgIAogICAgZGVmIFN0ZWFsU3lzdGVtSW5mbyhzZWxmKToKICAgICAgICB0Z19sb2dnZXIuaW5mbygiQ29sbGVjdGluZyBzeXN0ZW0gaW5mby4uLiIpCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpbmZvID0gW10KICAgICAgICAgICAgaW5mby5hcHBlbmQoZiJDb21wdXRlciBOYW1lOiB7b3MuZ2V0ZW52KCdjb21wdXRlcm5hbWUnLCAnVW5rbm93bicpfSIpCiAgICAgICAgICAgIGluZm8uYXBwZW5kKGYiVXNlcm5hbWU6IHtvcy5nZXRsb2dpbigpfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE9TCiAgICAgICAgICAgIHJlc3VsdCA9IHN1YnByb2Nlc3MucnVuKCd3bWljIG9zIGdldCBDYXB0aW9uJywgY2FwdHVyZV9vdXRwdXQ9VHJ1ZSwgc2hlbGw9VHJ1ZSkKICAgICAgICAgICAgb3NfaW5mbyA9IHJlc3VsdC5zdGRvdXQuZGVjb2RlKGVycm9ycz0naWdub3JlJykuc3RyaXAoKS5zcGxpdGxpbmVzKCkKICAgICAgICAgICAgaW5mby5hcHBlbmQoZiJPUzoge29zX2luZm9bMl0uc3RyaXAoKSBpZiBsZW4ob3NfaW5mbykgPj0gMiBlbHNlICdVbmtub3duJ30iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDUFUKICAgICAgICAgICAgcmVzdWx0ID0gc3VicHJvY2Vzcy5ydW4oInBvd2Vyc2hlbGwgR2V0LUl0ZW1Qcm9wZXJ0eVZhbHVlIC1QYXRoICdIS0xNOlN5c3RlbVxcQ3VycmVudENvbnRyb2xTZXRcXENvbnRyb2xcXFNlc3Npb24gTWFuYWdlclxcRW52aXJvbm1lbnQnIC1OYW1lIFBST0NFU1NPUl9JREVOVElGSUVSIiwgY2FwdHVyZV9vdXRwdXQ9VHJ1ZSwgc2hlbGw9VHJ1ZSkKICAgICAgICAgICAgaW5mby5hcHBlbmQoZiJDUFU6IHtyZXN1bHQuc3Rkb3V0LmRlY29kZShlcnJvcnM9J2lnbm9yZScpLnN0cmlwKCl9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUkFNCiAgICAgICAgICAgIHJlc3VsdCA9IHN1YnByb2Nlc3MucnVuKCd3bWljIGNvbXB1dGVyc3lzdGVtIGdldCB0b3RhbHBoeXNpY2FsbWVtb3J5JywgY2FwdHVyZV9vdXRwdXQ9VHJ1ZSwgc2hlbGw9VHJ1ZSkKICAgICAgICAgICAgcmFtID0gcmVzdWx0LnN0ZG91dC5kZWNvZGUoZXJyb3JzPSdpZ25vcmUnKS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgaWYgbGVuKHJhbSkgPj0gMToKICAgICAgICAgICAgICAgIHJhbV9nYiA9IGludChpbnQocmFtWzFdKS8xMDAwMDAwMDAwKQogICAgICAgICAgICAgICAgaW5mby5hcHBlbmQoZiJSQU06IHtyYW1fZ2J9IEdCIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgR1BVCiAgICAgICAgICAgIHJlc3VsdCA9IHN1YnByb2Nlc3MucnVuKCJ3bWljIHBhdGggd2luMzJfVmlkZW9Db250cm9sbGVyIGdldCBuYW1lIiwgY2FwdHVyZV9vdXRwdXQ9VHJ1ZSwgc2hlbGw9VHJ1ZSkKICAgICAgICAgICAgZ3B1ID0gcmVzdWx0LnN0ZG91dC5kZWNvZGUoZXJyb3JzPSdpZ25vcmUnKS5zcGxpdGxpbmVzKCkKICAgICAgICAgICAgaW5mby5hcHBlbmQoZiJHUFU6IHtncHVbMl0uc3RyaXAoKSBpZiBsZW4oZ3B1KSA+PSAyIGVsc2UgJ1Vua25vd24nfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIElQCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJlc3BvbnNlID0gdXJsb3BlbigiaHR0cDovL2lwLWFwaS5jb20vanNvbi8/ZmllbGRzPXF1ZXJ5LGNvdW50cnksY2l0eSIsIHRpbWVvdXQ9NSkKICAgICAgICAgICAgICAgIGlwX2RhdGEgPSBqc29uLmxvYWRzKHJlc3BvbnNlLnJlYWQoKS5kZWNvZGUoKSkKICAgICAgICAgICAgICAgIGluZm8uYXBwZW5kKGYiSVA6IHtpcF9kYXRhLmdldCgncXVlcnknLCAnVW5rbm93bicpfSIpCiAgICAgICAgICAgICAgICBpbmZvLmFwcGVuZChmIkxvY2F0aW9uOiB7aXBfZGF0YS5nZXQoJ2NpdHknLCAnJyl9LCB7aXBfZGF0YS5nZXQoJ2NvdW50cnknLCAnJyl9IikKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgaW5mby5hcHBlbmQoIklQOiBVbmFibGUgdG8gZGV0ZWN0IikKICAgICAgICAgICAgCiAgICAgICAgICAgIHN5c3RlbV9maWxlID0gb3MucGF0aC5qb2luKHNlbGYuVGVtcEZvbGRlciwgInN5c3RlbV9pbmZvLnR4dCIpCiAgICAgICAgICAgIHdpdGggb3BlbihzeXN0ZW1fZmlsZSwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICAgICAgZi53cml0ZSgiXG4iLmpvaW4oaW5mbykpCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLlN5c3RlbUluZm9TdG9sZW4gPSBUcnVlCiAgICAgICAgICAgIHRnX2xvZ2dlci5pbmZvKCJTeXN0ZW0gaW5mbyBjb2xsZWN0ZWQiKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHRnX2xvZ2dlci5lcnJvcihmIlN5c3RlbSBpbmZvIGVycm9yOiB7ZX0iKQogICAgCiAgICBkZWYgVGFrZVNjcmVlbnNob3Qoc2VsZik6CiAgICAgICAgdGdfbG9nZ2VyLmluZm8oIlRha2luZyBzY3JlZW5zaG90Li4uIikKICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgIGZyb20gY3R5cGVzIGltcG9ydCB3aW5kbGwKICAgICAgICAgICAgaW1wb3J0IHN0cnVjdAogICAgICAgICAgICAKICAgICAgICAgICAgIyBHZXQgc2NyZWVuIGRpbWVuc2lvbnMKICAgICAgICAgICAgdXNlcjMyID0gd2luZGxsLnVzZXIzMgogICAgICAgICAgICB3aWR0aCA9IHVzZXIzMi5HZXRTeXN0ZW1NZXRyaWNzKDApCiAgICAgICAgICAgIGhlaWdodCA9IHVzZXIzMi5HZXRTeXN0ZW1NZXRyaWNzKDEpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENhcHR1cmUgc2NyZWVuIHVzaW5nIGN0eXBlcwogICAgICAgICAgICBoZGMgPSB1c2VyMzIuR2V0REMoMCkKICAgICAgICAgICAgZ2RpMzIgPSB3aW5kbGwuZ2RpMzIKICAgICAgICAgICAgCiAgICAgICAgICAgIG1lbWRjID0gZ2RpMzIuQ3JlYXRlQ29tcGF0aWJsZURDKGhkYykKICAgICAgICAgICAgYml0bWFwID0gZ2RpMzIuQ3JlYXRlQ29tcGF0aWJsZUJpdG1hcChoZGMsIHdpZHRoLCBoZWlnaHQpCiAgICAgICAgICAgIGdkaTMyLlNlbGVjdE9iamVjdChtZW1kYywgYml0bWFwKQogICAgICAgICAgICBnZGkzMi5CaXRCbHQobWVtZGMsIDAsIDAsIHdpZHRoLCBoZWlnaHQsIGhkYywgMCwgMCwgMHgwMENDMDAyMCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ3JlYXRlIEJNUCBmaWxlCiAgICAgICAgICAgIGJtcF9oZWFkZXIgPSBzdHJ1Y3QucGFjaygnPDJzSUhISScsIGInQk0nLCA1NCArIHdpZHRoICogaGVpZ2h0ICogMywgMCwgMCwgNTQpCiAgICAgICAgICAgIGRpYl9oZWFkZXIgPSBzdHJ1Y3QucGFjaygnPElJSUhISUlJSUlJJywgNDAsIHdpZHRoLCBoZWlnaHQsIDEsIDI0LCAwLCB3aWR0aCAqIGhlaWdodCAqIDMsIDAsIDAsIDAsIDApCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEdldCBiaXRtYXAgYml0cwogICAgICAgICAgICBidWZmZXIgPSBjdHlwZXMuY3JlYXRlX3N0cmluZ19idWZmZXIod2lkdGggKiBoZWlnaHQgKiA0KQogICAgICAgICAgICAKICAgICAgICAgICAgY2xhc3MgQklUTUFQSU5GT0hFQURFUihjdHlwZXMuU3RydWN0dXJlKToKICAgICAgICAgICAgICAgIF9maWVsZHNfID0gWygnYmlTaXplJywgY3R5cGVzLmNfdWxvbmcpLCAoJ2JpV2lkdGgnLCBjdHlwZXMuY19sb25nKSwgKCdiaUhlaWdodCcsIGN0eXBlcy5jX2xvbmcpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAoJ2JpUGxhbmVzJywgY3R5cGVzLmNfdXNob3J0KSwgKCdiaUJpdENvdW50JywgY3R5cGVzLmNfdXNob3J0KSwgKCdiaUNvbXByZXNzaW9uJywgY3R5cGVzLmNfdWxvbmcpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAoJ2JpU2l6ZUltYWdlJywgY3R5cGVzLmNfdWxvbmcpLCAoJ2JpWFBlbHNQZXJNZXRlcicsIGN0eXBlcy5jX2xvbmcpLCAoJ2JpWVBlbHNQZXJNZXRlcicsIGN0eXBlcy5jX2xvbmcpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAoJ2JpQ2xyVXNlZCcsIGN0eXBlcy5jX3Vsb25nKSwgKCdiaUNsckltcG9ydGFudCcsIGN0eXBlcy5jX3Vsb25nKV0KICAgICAgICAgICAgCiAgICAgICAgICAgIGJpID0gQklUTUFQSU5GT0hFQURFUigpCiAgICAgICAgICAgIGJpLmJpU2l6ZSA9IDQwCiAgICAgICAgICAgIGJpLmJpV2lkdGggPSB3aWR0aAogICAgICAgICAgICBiaS5iaUhlaWdodCA9IC1oZWlnaHQKICAgICAgICAgICAgYmkuYmlQbGFuZXMgPSAxCiAgICAgICAgICAgIGJpLmJpQml0Q291bnQgPSAzMgogICAgICAgICAgICAKICAgICAgICAgICAgZ2RpMzIuR2V0RElCaXRzKG1lbWRjLCBiaXRtYXAsIDAsIGhlaWdodCwgYnVmZmVyLCBjdHlwZXMuYnlyZWYoYmkpLCAwKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDbGVhbnVwCiAgICAgICAgICAgIGdkaTMyLkRlbGV0ZU9iamVjdChiaXRtYXApCiAgICAgICAgICAgIGdkaTMyLkRlbGV0ZURDKG1lbWRjKQogICAgICAgICAgICB1c2VyMzIuUmVsZWFzZURDKDAsIGhkYykKICAgICAgICAgICAgCiAgICAgICAgICAgICMgU2F2ZSBhcyBzaW1wbGUgZm9ybWF0CiAgICAgICAgICAgIHNjcmVlbnNob3RfZmlsZSA9IG9zLnBhdGguam9pbihzZWxmLlRlbXBGb2xkZXIsICJzY3JlZW5zaG90LmJtcCIpCiAgICAgICAgICAgIHdpdGggb3BlbihzY3JlZW5zaG90X2ZpbGUsICJ3YiIpIGFzIGY6CiAgICAgICAgICAgICAgICAjIFdyaXRlIGEgc2ltcGxlIEJNUAogICAgICAgICAgICAgICAgZi53cml0ZShidWZmZXIucmF3KQogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5TY3JlZW5zaG90VGFrZW4gPSBUcnVlCiAgICAgICAgICAgIHRnX2xvZ2dlci5pbmZvKCJTY3JlZW5zaG90IGNhcHR1cmVkIikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICB0Z19sb2dnZXIud2FybmluZyhmIlNjcmVlbnNob3QgZXJyb3I6IHtlfSIpCiAgICAKICAgIGRlZiBDcmVhdGVBcmNoaXZlKHNlbGYpIC0+IHN0cjoKICAgICAgICB0Z19sb2dnZXIuaW5mbygiQ3JlYXRpbmcgYXJjaGl2ZS4uLiIpCiAgICAgICAgCiAgICAgICAgYXJjaGl2ZV9wYXRoID0gb3MucGF0aC5qb2luKG9zLmdldGVudigidGVtcCIpLCBmIlN0YXJTdGVhbGVyX3tvcy5nZXRsb2dpbigpfS56aXAiKQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgaW1wb3J0IHppcGZpbGUKICAgICAgICAgICAgd2l0aCB6aXBmaWxlLlppcEZpbGUoYXJjaGl2ZV9wYXRoLCAndycsIHppcGZpbGUuWklQX0RFRkxBVEVEKSBhcyB6aXBmOgogICAgICAgICAgICAgICAgZm9yIHJvb3QsIGRpcnMsIGZpbGVzIGluIG9zLndhbGsoc2VsZi5UZW1wRm9sZGVyKToKICAgICAgICAgICAgICAgICAgICBmb3IgZmlsZSBpbiBmaWxlczoKICAgICAgICAgICAgICAgICAgICAgICAgZmlsZV9wYXRoID0gb3MucGF0aC5qb2luKHJvb3QsIGZpbGUpCiAgICAgICAgICAgICAgICAgICAgICAgIGFyY25hbWUgPSBvcy5wYXRoLnJlbHBhdGgoZmlsZV9wYXRoLCBzZWxmLlRlbXBGb2xkZXIpCiAgICAgICAgICAgICAgICAgICAgICAgIHppcGYud3JpdGUoZmlsZV9wYXRoLCBhcmNuYW1lKQogICAgICAgICAgICAKICAgICAgICAgICAgdGdfbG9nZ2VyLmluZm8oZiJBcmNoaXZlIGNyZWF0ZWQ6IHthcmNoaXZlX3BhdGh9IikKICAgICAgICAgICAgcmV0dXJuIGFyY2hpdmVfcGF0aAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgdGdfbG9nZ2VyLmVycm9yKGYiQXJjaGl2ZSBjcmVhdGlvbiBlcnJvcjoge2V9IikKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgIAogICAgZGVmIFNlbmREYXRhKHNlbGYpOgogICAgICAgIHRnX2xvZ2dlci5pbmZvKCJTZW5kaW5nIGRhdGEgdG8gVGVsZWdyYW0uLi4iKQogICAgICAgIAogICAgICAgIGFyY2hpdmVfcGF0aCA9IHNlbGYuQ3JlYXRlQXJjaGl2ZSgpCiAgICAgICAgCiAgICAgICAgaWYgYXJjaGl2ZV9wYXRoIGFuZCBvcy5wYXRoLmlzZmlsZShhcmNoaXZlX3BhdGgpOgogICAgICAgICAgICAjINCh0L7QsdC40YDQsNC10Lwg0LjQvdGE0L7RgNC80LDRhtC40Y4g0L4g0YHQuNGB0YLQtdC80LUKICAgICAgICAgICAgY29tcHV0ZXJfbmFtZSA9IG9zLmdldGVudigiY29tcHV0ZXJuYW1lIiwgIlVua25vd24iKQogICAgICAgICAgICB1c2VybmFtZSA9IG9zLmdldGxvZ2luKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJlc3BvbnNlID0gdXJsb3BlbigiaHR0cDovL2lwLWFwaS5jb20vanNvbi8/ZmllbGRzPXF1ZXJ5LGNvdW50cnksY2l0eSIsIHRpbWVvdXQ9NSkKICAgICAgICAgICAgICAgIGlwX2RhdGEgPSBqc29uLmxvYWRzKHJlc3BvbnNlLnJlYWQoKS5kZWNvZGUoKSkKICAgICAgICAgICAgICAgIGlwX2luZm8gPSBmIntpcF9kYXRhLmdldCgncXVlcnknLCAnVW5rbm93bicpfSAoe2lwX2RhdGEuZ2V0KCdjb3VudHJ5JywgJycpfSkiCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIGlwX2luZm8gPSAiVW5rbm93biIKICAgICAgICAgICAgCiAgICAgICAgICAgIGNhcHRpb24gPSAoCiAgICAgICAgICAgICAgICBmIvCfjq8gU3RhciBTdGVhbGVyIExvZ1xuXG4iCiAgICAgICAgICAgICAgICBmIvCfkaQgVXNlcjoge3VzZXJuYW1lfVxuIgogICAgICAgICAgICAgICAgZiLwn5K7IFBDOiB7Y29tcHV0ZXJfbmFtZX1cbiIKICAgICAgICAgICAgICAgIGYi8J+MkCBJUDoge2lwX2luZm99XG5cbiIKICAgICAgICAgICAgICAgIGYi8J+TiiBQYXNzd29yZHM6IHtzZWxmLlBhc3N3b3Jkc0NvdW50fVxuIgogICAgICAgICAgICAgICAgZiLwn42qIENvb2tpZXM6IHtzZWxmLkNvb2tpZXNDb3VudH1cbiIKICAgICAgICAgICAgICAgIGYi8J+TtiBXaUZpOiB7c2VsZi5XaWZpUGFzc3dvcmRzQ291bnR9XG4iCiAgICAgICAgICAgICAgICBmIvCfk7EgVGVsZWdyYW06IHtzZWxmLlRlbGVncmFtU2Vzc2lvbnNDb3VudH0iCiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgICMg0J7RgtC/0YDQsNCy0LvRj9C10Lwg0LDRgNGF0LjQsgogICAgICAgICAgICBpZiB0Z19sb2dnZXIuc2VuZF9maWxlKGFyY2hpdmVfcGF0aCwgY2FwdGlvbik6CiAgICAgICAgICAgICAgICB0Z19sb2dnZXIuaW5mbygiRGF0YSBzZW50IHN1Y2Nlc3NmdWxseSEiKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgdGdfbG9nZ2VyLmVycm9yKCJGYWlsZWQgdG8gc2VuZCBkYXRhIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMg0KPQtNCw0LvRj9C10Lwg0LDRgNGF0LjQsgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBvcy5yZW1vdmUoYXJjaGl2ZV9wYXRoKQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBDbGVhbnVwKHNlbGYpOgogICAgICAgIHRnX2xvZ2dlci5pbmZvKCJDbGVhbmluZyB1cC4uLiIpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzaHV0aWwucm10cmVlKHNlbGYuVGVtcEZvbGRlciwgaWdub3JlX2Vycm9ycz1UcnVlKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcGFzcwoKCmRlZiBtYWluKCk6CiAgICBwcmludCgiPSIgKiA1MCkKICAgIHByaW50KCJTdGFyIFN0ZWFsZXIgLSBUZWxlZ3JhbSBFZGl0aW9uIikKICAgIHByaW50KCI9IiAqIDUwKQogICAgCiAgICAjINCf0YDQvtCy0LXRgNGP0LXQvCDQntChCiAgICBpZiBvcy5uYW1lICE9ICJudCI6CiAgICAgICAgcHJpbnQoIltFUlJPUl0gVGhpcyBzY3JpcHQgb25seSB3b3JrcyBvbiBXaW5kb3dzISIpCiAgICAgICAgcmV0dXJuCiAgICAKICAgICMg0J/RgNC+0LLQtdGA0Y/QtdC8INC40L3RgtC10YDQvdC10YIKICAgIGlmIG5vdCBVdGlsaXR5LklzQ29ubmVjdGVkVG9JbnRlcm5ldCgpOgogICAgICAgIHByaW50KCJbRVJST1JdIE5vIGludGVybmV0IGNvbm5lY3Rpb24hIikKICAgICAgICByZXR1cm4KICAgIAogICAgIyDQn9GA0L7QstC10YDRj9C10LwgbXV0ZXggKNGH0YLQvtCx0Ysg0L3QtSDQt9Cw0L/Rg9GB0LrQsNC70YHRjyDQtNCy0LDQttC00YspCiAgICBpZiBub3QgU3lzY2FsbHMuQ3JlYXRlTXV0ZXgoU2V0dGluZ3MuTXV0ZXgpOgogICAgICAgIHByaW50KCJbRVJST1JdIEFscmVhZHkgcnVubmluZyEiKQogICAgICAgIHJldHVybgogICAgCiAgICAjINCh0LrRgNGL0LLQsNC10Lwg0LrQvtC90YHQvtC70Ywg0LXRgdC70Lgg0L3Rg9C20L3QvgogICAgaWYgU2V0dGluZ3MuSGlkZUNvbnNvbGU6CiAgICAgICAgU3lzY2FsbHMuSGlkZUNvbnNvbGUoKQogICAgCiAgICAjINCX0LDQv9GD0YHQutCw0LXQvCDRgdCx0L7RgNGJ0LjQugogICAgU3RhclN0ZWFsZXIoKQogICAgCiAgICBwcmludCgiXG5bRE9ORV0gRXhlY3V0aW9uIGNvbXBsZXRlZCEiKQoKCmlmIF9fbmFtZV9fID09ICJfX21haW5fXyI6CiAgICBtYWluKCkK").decode("utf-8"))
